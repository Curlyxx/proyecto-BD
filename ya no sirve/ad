let isTyping = false; // Estado para saber si la IA está escribiendo
let typingInterval; // Intervalo de la animación de escritura
let isFirstMessage = true; // Bandera para saber si es el primer mensaje
let lastAiMessage = ""; // Almacena el último mensaje de la IA
let isSpeaking = false; // Estado para saber si la IA está hablando
let lastAudio = null; // Almacena el último audio generado

// Función para limpiar el chat
function clearChat() {
    let chat = document.getElementById("chat");
    chat.innerHTML = ""; // Elimina todos los mensajes del chat
    lastAiMessage = ""; // Limpiar el último mensaje almacenado
    if (lastAudio) {
        lastAudio.pause(); // Detener el audio si está reproduciéndose
        lastAudio = null;
    }
}

// Asignar la función clearChat al botón "Nuevo Chat"
document.getElementById("newChatButton").addEventListener("click", clearChat);

// Función para animar la escritura de un mensaje
function typeMessage(message, element, callback) {
    let text = "";
    let index = 0;
    typingInterval = setInterval(() => {
        if (index < message.length) {
            text += message.charAt(index);
            element.innerHTML = text; // Usar innerHTML para mantener el formato
            index++;
        } else {
            clearInterval(typingInterval);
            isTyping = false;
            if (callback) callback(); // Llamar al callback si está definido
        }
    }, 30); // Velocidad de escritura (30ms por letra)
}

// Función para enviar una pregunta
function submitComment() {
    let input = document.getElementById("userInput");
    let chat = document.getElementById("chat");

    if (input.value.trim() !== "" && !isTyping) {
        // Mostrar el cuadro de chat si es el primer mensaje
        if (isFirstMessage) {
            chat.classList.add("visible"); // Añade la clase para mostrar el chat
            isFirstMessage = false; // Cambia la bandera para que no se repita
        }

        // Mostrar el mensaje del usuario
        let userMessage = document.createElement("div");
        userMessage.classList.add("message", "user-message");
        userMessage.textContent = input.value;
        chat.appendChild(userMessage);

        // Deshabilitar el input y cambiar el botón a "Parar"
        input.disabled = true;
        document.getElementById("sendButton").style.display = "none";
        document.getElementById("stopButton").style.display = "inline-block";
        isTyping = true;

        // Hacer una solicitud al backend de Flask
        fetch(`http://localhost:5001/obtener_info?termino=${encodeURIComponent(input.value)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }

                // Almacenar el último mensaje de la IA
                lastAiMessage = data.contenido;

                // Generar una respuesta de la IA
                let aiMessage = document.createElement("div");
                aiMessage.classList.add("message", "ai-message");
                chat.appendChild(aiMessage);

                // Mostrar la respuesta con animación de escritura
                typeMessage(data.contenido, aiMessage, () => {
                    input.disabled = false; // Habilitar el input cuando la IA termina de escribir
                    document.getElementById("sendButton").style.display = "inline-block";
                    document.getElementById("stopButton").style.display = "none";
                });

                // Generar el audio del último mensaje
                fetch(`http://localhost:5001/hablar?texto=${encodeURIComponent(data.contenido)}`)
                    .then(response => response.json())
                    .then(audioData => {
                        if (audioData.error) {
                            throw new Error(audioData.error);
                        }
                        lastAudio = new Audio(audioData.audioUrl); // Guardar el audio en una variable
                    })
                    .catch(error => {
                        console.error("Error al generar el audio:", error);
                    });
            })
            .catch(error => {
                console.error('Error:', error);
                // Mostrar un mensaje de error en caso de fallo
                let aiMessage = document.createElement("div");
                aiMessage.classList.add("message", "ai-message");
                chat.appendChild(aiMessage);

                // Mostrar el mensaje de error con animación de escritura
                typeMessage("Hubo un error al procesar tu solicitud. Inténtalo de nuevo.", aiMessage, () => {
                    input.disabled = false; // Habilitar el input cuando la IA termina de escribir
                    document.getElementById("sendButton").style.display = "inline-block";
                    document.getElementById("stopButton").style.display = "none";
                });
            });

        // Limpiar el campo de entrada
        input.value = "";

        // Desplazar el chat hacia abajo
        chat.scrollTop = chat.scrollHeight;
    }
}

// Función para leer el último mensaje de la IA
function readText() {
    if (lastAudio && lastAiMessage.trim() !== "") {
        if (!isSpeaking) {
            // Cambiar el botón "Leer" a "Parar"
            document.getElementById("readButton").style.display = "none";
            document.getElementById("stopSpeechButton").style.display = "inline-block";
            isSpeaking = true;

            // Reproducir el audio
            lastAudio.play();

            // Cuando termine de hablar, cambiar el botón de nuevo a "Leer"
            lastAudio.onended = () => {
                document.getElementById("readButton").style.display = "inline-block";
                document.getElementById("stopSpeechButton").style.display = "none";
                isSpeaking = false;
            };
        }
    } else {
        alert("No hay texto para leer o el audio no está disponible.");
    }
}

// Función para detener la reproducción de voz
function stopSpeech() {
    if (isSpeaking && lastAudio) {
        lastAudio.pause(); // Detener la reproducción
        lastAudio.currentTime = 0; // Reiniciar el audio
        document.getElementById("readButton").style.display = "inline-block";
        document.getElementById("stopSpeechButton").style.display = "none";
        isSpeaking = false;
    }
}

// Event listener para enviar el mensaje al presionar Enter
document.getElementById("userInput").addEventListener("keypress", function (event) {
    if (event.key === "Enter") {
        event.preventDefault(); // Evitar el comportamiento por defecto (como enviar un formulario)
        submitComment(); // Llamar a la función submitComment
    }
});

// Asignar la función submitComment al botón "Enviar"
document.getElementById("sendButton").addEventListener("click", submitComment);

// Asignar la función readText al botón "Leer"
document.getElementById("readButton").addEventListener("click", readText);

// Asignar la función stopSpeech al botón "Parar"
document.getElementById("stopSpeechButton").addEventListener("click", stopSpeech);

// Función para detener la animación de escritura
function stopTyping() {
    if (isTyping) {
        clearInterval(typingInterval); // Detener la animación de escritura
        isTyping = false;
        document.getElementById("userInput").disabled = false; // Habilitar el input
        document.getElementById("sendButton").style.display = "inline-block";
        document.getElementById("stopButton").style.display = "none";
    }
}